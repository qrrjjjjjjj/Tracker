workflows:
  android-ci:
    name: Android CI
    max_build_duration: 60
    environment:
      vars:
        VERSION_NAME: $(date +'%Y.%m.%d')
        VERSION_CODE: $CM_BUILD_ID
        GRADLE_OPTS: -Dorg.gradle.daemon=false -Dorg.gradle.jvmargs=-Xmx4096m
      java: 21

    cache:
      cache_paths:
        - ~/.gradle/caches
        - ~/.gradle/wrapper
        - ~/.android/build-cache

    triggering:
      events:
        - push
        - pull_request
      branch_patterns:
        - pattern: 'main'
          include: true
        - pattern: 'master'
          include: true

    scripts:
      - name: Prepare Gradle
        script: |
          echo "‚öôÔ∏è Setting up Gradle wrapper..."
          chmod +x gradlew

      - name: Validate Gradle Wrapper
        script: |
          echo "üîç Validating Gradle wrapper (8.9)..."
          ./gradlew wrapper --gradle-version 8.9

      - name: Build Release APK
        script: |
          echo "üöÄ Building release APK..."
          ./gradlew clean assembleRelease

      - name: Rename APK for versioning
        script: |
          echo "üß± Renaming output APK..."
          OUTDIR="app/build/outputs/apk/release"
          NEWNAME="Tracker_v${VERSION_NAME}_build${VERSION_CODE}.apk"
          mv "$OUTDIR/app-release.apk" "$OUTDIR/$NEWNAME" || echo "‚ö†Ô∏è APK rename skipped (file not found)"

      - name: List output files
        script: |
          echo "üì¶ Final output:"
          ls -lh app/build/outputs/apk/release/

    artifacts:
      - app/build/outputs/apk/release/*.apk
